# Унифицированные правила импорта для всех платформ

## Резюме изменений

Все платформы (Telegram, WhatsApp, Signal, Viber, Discord, iMessage, Messenger, **Generic TXT**) теперь используют **одинаковые правила** без исключений.

## Что было исправлено

### 1. ✅ Убрано жесткое ограничение 4000 сообщений для Generic TXT

**Было:**
- Generic TXT файлы обрезались до 4000 сообщений независимо от subscription tier
- Это было жестко закодировано в `parseGenericTextExport`

**Стало:**
- Generic TXT использует те же лимиты что и все остальные платформы
- Free tier: 50,000 сообщений
- Premium tier: 500,000 сообщений
- Проверка происходит на уровне API (как и для других платформ)

**Файл:** `features/import/parsers.ts`

---

### 2. ✅ Унифицирована валидация размера файла

**Все платформы:**
- Максимальный размер: `MAX_UPLOAD_SIZE_MB` (default: 25MB)
- Проверка размера в `/api/import` и `/api/import/blob`
- Одинаковые сообщения об ошибках

**Файлы:**
- `app/api/import/route.ts`
- `app/api/import/blob/route.ts`

---

### 3. ✅ Унифицирована валидация content type

**Все платформы:**
- Free tier: `.json`, `.txt` файлы
- Premium tier: `.json`, `.txt`, `.zip` файлы
- Проверка по расширению файла и content type
- Одинаковая логика в обоих endpoints

---

### 4. ✅ Унифицированы лимиты сообщений

**Все платформы:**
- Free tier: 50,000 сообщений
- Premium tier: 500,000 сообщений
- Проверка после парсинга (на уровне API)
- Одинаковые сообщения об ошибках

---

### 5. ✅ Унифицирован rate limiting

**Все endpoints:**
- `/api/import`: 5 запросов/минуту
- `/api/import/blob`: 5 запросов/минуту
- `/api/upload-to-blob`: 5 запросов/минуту
- Использует Redis (atomic) или in-memory fallback
- Одинаковые ключи и лимиты

---

### 6. ✅ Унифицирована обработка больших файлов

**Все платформы:**
- Файлы >4MB автоматически загружаются через Vercel Blob
- Файлы ≤4MB загружаются напрямую
- Прозрачно для пользователя
- Одинаковая логика для всех платформ

---

## Текущие правила (одинаковые для всех платформ)

### Размер файла
- **Прямая загрузка**: ≤4MB (обход лимита Vercel 4.5MB)
- **Blob загрузка**: >4MB до `MAX_UPLOAD_SIZE_MB` (default: 25MB)
- **Проверка**: В обоих endpoints одинаково

### Лимиты сообщений
- **Free tier**: 50,000 сообщений
- **Premium tier**: 500,000 сообщений
- **Проверка**: После парсинга, на уровне API

### Content Types
- **Free tier**: `application/json`, `text/plain`, `.json`, `.txt`
- **Premium tier**: + `application/zip`, `.zip`

### Rate Limiting
- **Лимит**: 5 запросов/минуту per IP
- **Реализация**: Redis (atomic) или in-memory
- **Endpoints**: Все import endpoints

### Storage
- **Redis**: Progress, jobs, малые результаты (<1MB)
- **Vercel Blob**: Большие результаты (≥1MB), большие файлы (>4MB)
- **TTL**: 2 часа (auto-extended)

---

## Сравнение: До и После

### Generic TXT (Plain TXT / Other)

**До:**
- ❌ Жесткое ограничение 4000 сообщений
- ❌ Обрезание файла без учета subscription tier
- ❌ Разные правила чем у других платформ

**После:**
- ✅ Те же лимиты что и у Telegram/WhatsApp
- ✅ Free: 50k, Premium: 500k сообщений
- ✅ Одинаковые правила со всеми платформами

### Все платформы

**До:**
- ⚠️ Разные правила для разных платформ
- ⚠️ Generic имел специальное ограничение
- ⚠️ Непоследовательная валидация

**После:**
- ✅ Полностью унифицированные правила
- ✅ Одинаковая валидация везде
- ✅ Одинаковые сообщения об ошибках
- ✅ Одинаковая обработка больших файлов

---

## Проверка правил

### Для всех платформ должно работать одинаково:

1. ✅ **Размер файла**: Проверяется до парсинга
2. ✅ **Content type**: Проверяется до парсинга
3. ✅ **ZIP файлы**: Требуют premium
4. ✅ **Лимит сообщений**: Проверяется после парсинга
5. ✅ **Rate limiting**: 5 req/min для всех
6. ✅ **Большие файлы**: Автоматически через Blob
7. ✅ **Redis/Blob**: Одинаковые правила хранения

---

## Файлы изменены

1. `features/import/parsers.ts` - убрано ограничение 4000 для generic
2. `app/api/import/blob/route.ts` - добавлена валидация размера и content type
3. `app/page.tsx` - автоматическая Blob загрузка для больших файлов
4. `docs/IMPORT_RULES.md` - документация правил
5. `docs/UNIFIED_IMPORT_RULES.md` - этот документ

---

## Тестирование

Все платформы должны быть протестированы с:

### Generic TXT
- ✅ Малый файл (<4MB, <50k сообщений) - free tier
- ✅ Средний файл (<4MB, >50k сообщений) - должен показать ошибку free tier
- ✅ Большой файл (>4MB) - должен использовать Blob upload
- ✅ Premium tier - должен принимать до 500k сообщений

### Все платформы
- ✅ Одинаковые лимиты
- ✅ Одинаковая валидация
- ✅ Одинаковые сообщения об ошибках

---

## Резюме

✅ **Все платформы теперь имеют одинаковые правила:**
- Размер файла
- Лимиты сообщений
- Content type validation
- Rate limiting
- Storage rules
- Error handling

✅ **Generic TXT больше не имеет специальных ограничений**

✅ **Все правила применяются единообразно через API layer**

✅ **Redis и Blob используются одинаково для всех платформ**


